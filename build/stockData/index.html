<html>

<body>
    <h1 id="heading"></h1>
    <div id="CharContainer"></div>
    <div class="tooltip"></div>

    <head>
        <script src="https://d3js.org/d3.v4.js"></script>
        <script src="d3Chart.js"></script>
        <link rel="stylesheet" type="text/css" href="stock.css">

        <div id="StockSelect"></div>
        <button class="resetButton"> Reset</button>
    </head>
    <script>
        // Populate Drown Down from Fully Trained Model
        d3.csv('fullTrained.csv', function (d) {
            return {
                'symbol': d.Symbol,
                'company': d.Company,
                'loss': d.loss,
                'epochs': d.Epochs,
                'duration': d.Duration
            };
        }, function (error, data) {

            data = data.filter((thing, index, self) =>
                index === self.findIndex((t) => (
                    t.symbol === thing.symbol
                ))
            );
            data.push({
                'symbol': 'DontSelect',
                'company': '---'
            });
            d3.select("#StockSelect")
                .append("select")
                .on('change', function () {
                    var o = this.options[this.selectedIndex];
                    if (o.value === 'DontSelect') {
                        return;
                    }
                    d3.select('h1')
                        .text(o.text);
                    var url = "http://localhost:4242/stockData/" + o.value;
                    fetch(url)
                        .then(response => response.text())
                        .then(contents => {
                            // updateGraph(o.value, o.text).then((msg) => {
                            //     createFuturePrices(o.value);
                            // });

                            plotTestData(o.value);

                        })
                        .catch(() => console.log("Canâ€™t access " + url + " Blocked by browser?"))

                })
                .selectAll("option").data(data)
                .enter().append("option")
                .text(function (d) {
                    return d.company;
                })
                .attr("value", function (d) {
                    return d.symbol;
                });

            // Initial Value
            d3.select('select').property('value', 'DontSelect');
        });

        function updateGraph(stockSymbol, company) {
            d3.select('h1')
                .text(company);
            clearGraph();
            //plotStockPrice(stockSymbol + '_test.csv');
            //plotStockPrice(stockSymbol + '_test_pred.csv', true);

            return plotStockPrice(stockSymbol + '_train.csv');
        }

        function getNextDay(from, N) {
            var nextDay = new Date(from);
            nextDay.setDate(nextDay.getDate() + N);

            return nextDay;
        }

        function createFuturePrices(stockSymbol) {

            var futureDataSet = [];
            //Read the data
            d3.csv(stockSymbol + '_future.csv',
                // When reading the csv, I must format variables:
                function (d) {
                    return { value: +d.price }
                },

                // Now I can use this dataset:
                function (dataset) {
                    var totalFuturePrices = dataset.length;
                    var lastDate = getLastDate();
                    dataset.forEach((element, index) => {
                        futureDataSet.push({
                            'date': getNextDay(lastDate, index),
                            'value': element.value
                        })
                    });
                    console.log(futureDataSet);
                    showStockPrices(futureDataSet, true);
                });
        }
    </script>
</body>

</html>